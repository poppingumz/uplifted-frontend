stages:
  - build
  - test

variables:
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build --build-arg VITE_API_URL=http://localhost:8080 -t uplifted-frontend .
  artifacts:
    name: "frontend-image"
    expire_in: 1 hour

test:
  stage: test
  script:
    # Cleanup any leftovers (had error)
    - docker rm -f mysql_test backend_test frontend_test || Write-Host "No old test containers to remove"

    # Make sue network exists
    - |
      if (-not (docker network ls --filter name=^uplifted-net$ --format "{{.Name}}")) {
        docker network create uplifted-net
      } else {
        Write-Host "Network 'uplifted-net' already exists"
      }

    # Start MySQL on the network
    - docker run -d --rm --name mysql_test --network uplifted-net `
        -e MYSQL_ROOT_PASSWORD=root `
        -e MYSQL_DATABASE=testdb `
        -e MYSQL_USER=testuser `
        -e MYSQL_PASSWORD=testpass `
        mysql:8.0

    # Start backend_test without publishing
    - docker run -d --rm --name backend_test --network uplifted-net `
        -e SPRING_DATASOURCE_URL=jdbc:mysql://mysql_test:3306/testdb `
        -e SPRING_DATASOURCE_USERNAME=testuser `
        -e SPRING_DATASOURCE_PASSWORD=testpass `
        -e SPRING_JPA_HIBERNATE_DDL_AUTO=update `
        uplifted-backend

    # Rebuild frontend pointing to backend_test
    - docker build --build-arg VITE_API_URL=http://backend_test:8080 -t uplifted-frontend .

    # Start frontend_test and map
    - docker rm -f frontend_test 2>$null
    - docker run -d --rm --name frontend_test --network uplifted-net -p 5173:80 uplifted-frontend

    # Wait for services
    - Start-Sleep -Seconds 10

    # Run Cypress
    - Set-Location "$Env:CI_PROJECT_DIR"
    - npm install
    - npx cypress install
    - npx cypress run --config baseUrl=http://localhost:5173
