stages:
  - build
  - test

variables:
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  # (this job can still run in a Docker executor if you like)
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build --build-arg VITE_API_URL=http://localhost:8080 -t uplifted-frontend .
  artifacts:
    name: "frontend-image"
    expire_in: 1 hour

test:
  stage: test
  # â† ensure this job runs in your Windows shell
  tags:
    - shell
  script:
    # set up the Docker network & containers
    - docker network create uplifted-net
    - docker run -d --rm --name mysql_test --network uplifted-net `
        -e MYSQL_ROOT_PASSWORD=root `
        -e MYSQL_DATABASE=testdb `
        -e MYSQL_USER=testuser `
        -e MYSQL_PASSWORD=testpass `
        mysql:8.0
    - docker run -d --rm --name backend_test --network uplifted-net `
        -e SPRING_DATASOURCE_URL=jdbc:mysql://mysql_test:3306/testdb `
        -e SPRING_DATASOURCE_USERNAME=testuser `
        -e SPRING_DATASOURCE_PASSWORD=testpass `
        -e SPRING_JPA_HIBERNATE_DDL_AUTO=update `
        -p 8080:8080 `
        uplifted-backend
    - docker build --build-arg VITE_API_URL=http://backend_test:8080 -t uplifted-frontend .
    - docker rm -f frontend_test 2>$null
    - docker run -d --name frontend_test --network uplifted-net -p 5173:80 uplifted-frontend

    # give services a moment to start
    - Start-Sleep -Seconds 10

    # switch into your front-end folder
    - Set-Location "$Env:CI_PROJECT_DIR\uplifted-frontend"
    # install & run Cypress locally
    - npm install
    - npx cypress install
    - npx cypress run --config baseUrl=http://localhost:5173
